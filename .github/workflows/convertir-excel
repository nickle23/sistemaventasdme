name: üöÄ Convertir Excel a JSON Autom√°ticamente

on:
  push:
    paths:
      - '*.xlsx'
      - '*.xls'
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  convertir-excel:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Descargar c√≥digo
      uses: actions/checkout@v4
      
    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: üì¶ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pandas openpyxl
        
    - name: üîÑ Buscar y convertir Excel
      run: |
        echo "Buscando archivos Excel..."
        ls -la *.xlsx *.xls 2>/dev/null || echo "No se encontraron archivos Excel"
        
        # Script de conversi√≥n autom√°tica
        python << 'EOF'
        import json
        import pandas as pd
        import glob
        import os
        
        print("üîç Buscando archivos Excel...")
        excel_files = glob.glob("*.xlsx") + glob.glob("*.xls")
        
        if not excel_files:
            print("‚ùå No se encontraron archivos Excel")
            exit(1)
            
        excel_file = excel_files[0]
        print(f"üìñ Procesando: {excel_file}")
        
        try:
            # Leer Excel
            df = pd.read_excel(excel_file)
            print(f"‚úÖ Excel le√≠do: {len(df)} filas")
            
            # Convertir a formato optimizado
            productos = []
            for _, row in df.iterrows():
                producto = {
                    'codigo': str(row.get('C√≥digo', '')).strip(),
                    'descripcion': str(row.get('Descripcion', '')).strip(),
                    'unidad': str(row.get('Unidad', '')).strip(),
                    'precio': str(row.get('Precio', '0')).strip(),
                    'stock': str(row.get('StActual', '0')).strip(),
                    'precio_unit': str(row.get('Pr.Unit', '0')).strip()
                }
                productos.append(producto)
            
            # Guardar JSON
            with open('productos.json', 'w', encoding='utf-8') as f:
                json.dump(productos, f, ensure_ascii=False, indent=2)
                
            print(f"üéâ JSON creado: {len(productos)} productos")
            print("üìä Resumen:")
            print(f"   - Productos: {len(productos)}")
            print(f"   - Archivo: productos.json")
            
        except Exception as e:
            print(f"‚ùå Error: {e}")
            exit(1)
        EOF
        
    - name: üìä Verificar JSON creado
      run: |
        if [ -f "productos.json" ]; then
          echo "‚úÖ JSON creado exitosamente"
          echo "Productos count: $(jq length productos.json)"
        else
          echo "‚ùå ERROR: No se cre√≥ productos.json"
          exit 1
        fi
        
    - name: üöÄ Subir cambios autom√°ticamente
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add productos.json
        git diff --staged --quiet || git commit -m "üîÑ Actualizaci√≥n autom√°tica: JSON generado desde Excel"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
